name: Rule Factory (Sing-box & Mihomo)

# ===============================
# è§¦å‘æ¡ä»¶
# ===============================
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/factory.yml'

permissions:
  contents: write

jobs:
  produce-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. å®‰è£…æœºå™¨ï¼šsing-box å’Œ mihomo (ç¡¬ç¼–ç é“¾æ¥ï¼Œæœ€ç®€å•ç»´æŠ¤)
      - name: Install Dependencies
        run: |
          # --- A. å®‰è£… sing-box (ä¿æŒè‡ªåŠ¨æœ€æ–°ï¼Œå› ä¸ºå®ƒç¨³å®š) ---
          echo "--- Installing sing-box ---"
          S_VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r .tag_name)
          S_VERSION_NUM=${S_VERSION#v}
          wget --tries=5 "https://github.com/SagerNet/sing-box/releases/download/${S_VERSION}/sing-box-${S_VERSION_NUM}-linux-amd64.tar.gz"
          tar -zxvf "sing-box-${S_VERSION_NUM}-linux-amd64.tar.gz"
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sudo chmod +x /usr/local/bin/sing-box
          sing-box version
          
          # --- B. å®‰è£… mihomo (ä½¿ç”¨ç¡¬ç¼–ç å®Œæ•´é“¾æ¥) ---
          echo "--- Installing mihomo ---"
          
          # æ ¸å¿ƒä¿®æ­£: ç²˜è´´å®Œæ•´çš„ä¸‹è½½é“¾æ¥
          M_URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.16/mihomo-linux-amd64-v1.19.16.gz" # <-- è¯·åœ¨å‡çº§æ—¶æ‰‹åŠ¨æ›¿æ¢æ­¤é“¾æ¥

          echo "Downloading Mihomo from hard-coded URL..."
          
          wget --tries=5 "$M_URL" -O mihomo-download.gz

          if [ $? -ne 0 ]; then
             echo "Fatal Error: Mihomo download failed with 404. è¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶æ›´æ–° M_URL é“¾æ¥æ˜¯å¦æ­£ç¡®ã€‚"
             exit 1
          fi

          gunzip mihomo-download.gz

          M_EXECUTABLE=$(find . -maxdepth 1 -type f -name "mihomo-linux-amd64*" ! -name "*.gz" | head -n 1)

          if [ -z "$M_EXECUTABLE" ]; then
             M_EXECUTABLE=$(find . -maxdepth 1 -type f ! -name "*.gz" ! -name "mihomo-download" | head -n 1)
          fi
          
          if [ -z "$M_EXECUTABLE" ]; then
             echo "Fatal Error: Could not find the mihomo executable after unzipping. Cannot continue."
             exit 1
          fi
          
          chmod +x "$M_EXECUTABLE"
          sudo mv "$M_EXECUTABLE" /usr/local/bin/mihomo
          mihomo -v

      # 2. è¿è¡Œå·¥å‚ç”Ÿäº§çº¿
      - name: Run Factory Line (Process All Rules)
        run: |
          SOURCE_DIR="src"
          OUTPUT_DIR="rule-set"
          # ä½¿ç”¨ GITHUB_WORKSPACE ç¡®ä¿ä½¿ç”¨ç»å¯¹è·¯å¾„
          WORKSPACE_DIR="${{ github.workspace }}" 
          mkdir -p "$OUTPUT_DIR"
          shopt -s nullglob
          
          # --- B. è¿œç¨‹è¿›è´§æ¸…å• (Sing-box AdGuard è½¬æ¢) ---
          declare -a REMOTE_FILES=(
            "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt | AdGuardSDNSFilter"
          )
          
          # ----------------------------------------------------------------
          # 1. Processing Remote AdGuard Rules (å·²æ¢å¤)
          # ----------------------------------------------------------------
          echo ">>> 1. Processing Remote AdGuard Rules..."
          for rule in "${REMOTE_FILES[@]}"; do
            url="${rule%%|*}"
            name="${rule##*|}"
            url=$(echo "$url" | xargs)
            name=$(echo "$name" | xargs)

            echo "ğŸ“¥ Downloading: $name"
            curl --retry 5 --retry-delay 5 -L -s -o "temp_${name}.txt" "$url"

            if [ -f "temp_${name}.txt" ] && [ -s "temp_${name}.txt" ]; then
               sing-box rule-set convert --type adguard --output "${OUTPUT_DIR}/${name}.srs" "temp_${name}.txt" || echo "âš ï¸ Warning: sing-box conversion failed for ${name}"
               echo "âœ… Success: ${name}.srs"
               rm "temp_${name}.txt"
            else
               echo "âš ï¸ Warning: Download or file is empty: $url"
            fi
            echo "---"
          done

          # ----------------------------------------------------------------
          # 2. Processing Local Rules (src æ ¹ç›®å½•) (å·²æ¢å¤)
          # ----------------------------------------------------------------
          echo ">>> 2. Processing Local JSON & YAML Rules..."
          if [ -d "$SOURCE_DIR" ]; then
            
            # A. ç¼–è¯‘ Sing-box JSON (*.json -> .srs)
            for json_file in "$SOURCE_DIR"/*.json; do
              filename=$(basename "$json_file" .json)
              echo "ğŸ”¨ Compiling Sing-box JSON: $filename"
              sing-box rule-set compile --output "${OUTPUT_DIR}/${filename}.srs" "$json_file" || echo "âš ï¸ Warning: sing-box compilation failed for ${filename}"
            done

            # B. ç¼–è¯‘ Mihomo YAML (*.yaml / *.yml -> .mrs) - å¤„ç†æ ¹ç›®å½•ä¸‹çš„ Mihomo YAML
            if command -v mihomo &> /dev/null; then
                for yaml_file in "$SOURCE_DIR"/*.yaml "$SOURCE_DIR"/*.yml; do
                  base_name=$(basename "$yaml_file" | sed -E 's/\.y(a)?ml$//') 
                  echo "âš™ï¸ Converting Mihomo YAML: $base_name"
                  mihomo convert-ruleset domain yaml "$yaml_file" "${OUTPUT_DIR}/${base_name}.mrs" || echo "âš ï¸ Warning: mihomo YAML conversion failed for ${base_name}"
                done
            fi
          fi
          
          # ----------------------------------------------------------------
          # 3. Processing Mihomo List Rules (æŒ‰å­æ–‡ä»¶å¤¹åŒºåˆ†ç±»å‹)
          # ----------------------------------------------------------------
          
          # A. Domain YAML/List (src/domain/*.list & *.txt / *.yaml / *.yml)
          echo ">>> 3A. Processing Mihomo Domain Rules (src/domain)"
          if [ -d "$SOURCE_DIR/domain" ] && command -v mihomo &> /dev/null; then
            
            # 1. ä¼˜å…ˆå¤„ç† YAML/YML æ–‡ä»¶ (æœ€å¯é )
            for yaml_file in "$SOURCE_DIR"/domain/*.yaml "$SOURCE_DIR"/domain/*.yml; do
              filename=$(basename "$yaml_file" | sed -E 's/\.y(a)?ml$//')
              echo "âš™ï¸ Converting Domain YAML: $filename (Source: $yaml_file)"
              
              # ç»å¯¹è·¯å¾„ä¿®å¤
              INPUT_PATH="${WORKSPACE_DIR}/${yaml_file}"
              OUTPUT_PATH="${WORKSPACE_DIR}/rule-set/${filename}.mrs"
              
              mihomo convert-ruleset domain yaml "$INPUT_PATH" "$OUTPUT_PATH" || echo "âš ï¸ Warning: mihomo domain YAML conversion failed for ${filename}"
            done
            
            # 2. æ¬¡è¦å¤„ç† LIST/TXT æ–‡ä»¶ (æ‚¨æ‰‹åŠ¨ç¼–è¾‘çš„çº¯å‡€åˆ—è¡¨)
            for list_file in "$SOURCE_DIR"/domain/*.list "$SOURCE_DIR"/domain/*.txt; do
              filename=$(basename "$list_file")
              filename=${filename%.list}
              filename=${filename%.txt}

              echo "âš™ï¸ Converting Domain LIST: $filename (Source: $list_file)"
              
              # ç»å¯¹è·¯å¾„ä¿®å¤
              INPUT_PATH="${WORKSPACE_DIR}/${list_file}"
              OUTPUT_PATH="${WORKSPACE_DIR}/rule-set/${filename}.mrs"
              
              mihomo convert-ruleset domain text "$INPUT_PATH" "$OUTPUT_PATH" || echo "âš ï¸ Warning: mihomo domain list conversion failed for ${filename}"
            done
          fi

          # B. IP-CIDR åˆ—è¡¨ (src/ip/*.list & *.txt -> .mrs)
          echo ">>> 3B. Processing Mihomo IPCIDR Lists (src/ip)"
          if [ -d "$SOURCE_DIR/ip" ] && command -v mihomo &> /dev/null; then
            for list_file in "$SOURCE_DIR"/ip/*.list "$SOURCE_DIR"/ip/*.txt; do
              filename=$(basename "$list_file")
              filename=${filename%.list}
              filename=${filename%.txt}
              
              echo "âš™ï¸ Converting IPCIDR LIST: $filename"
              
              # ç»å¯¹è·¯å¾„ä¿®å¤
              INPUT_PATH="${WORKSPACE_DIR}/${list_file}"
              OUTPUT_PATH="${WORKSPACE_DIR}/rule-set/${filename}.mrs"

              mihomo convert-ruleset ipcidr text "$INPUT_PATH" "$OUTPUT_PATH" || echo "âš ï¸ Warning: mihomo ipcidr conversion failed for ${filename}"
              
            done
          fi
          
          # ğŸ æœ€ç»ˆè°ƒè¯•ç‚¹ï¼šæ‰“å°æˆå“ç›®å½•å†…å®¹
          echo "--- Debug: Final Contents of rule-set/ directory ---"
          ls -la "$OUTPUT_DIR/"
          echo "----------------------------------------------------"

      # 3. æäº¤æˆå“åˆ°ä»“åº“ (ä¿®å¤ Git æŠ¥é”™ 128)
      - name: Commit and Push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          find rule-set/ -name "*.srs" -o -name "*.mrs" | xargs git add
          
          git commit -m "Factory output update [skip ci]" || exit 0
          git push
