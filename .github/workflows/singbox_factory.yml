name: Sing-box Rule Factory

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/singbox_factory.yml'

permissions:
  contents: write

jobs:
  produce-srs-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. å®‰è£… Sing-box (ä¿®å¤ä¸ºç¡¬ç¼–ç ç‰ˆæœ¬ 1.12.12)
      - name: Install Sing-box
        run: |
          echo "--- Installing sing-box ---"
          # æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬å·
          S_VERSION_NUM="1.12.12" 
          wget --tries=5 "https://github.com/SagerNet/sing-box/releases/download/v${S_VERSION_NUM}/sing-box-${S_VERSION_NUM}-linux-amd64.tar.gz" -O sing-box.tar.gz
          tar -zxvf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sudo chmod +x /usr/local/bin/sing-box
          sing-box version 

      # 2. è¿è¡Œå·¥å‚ç”Ÿäº§çº¿
      - name: Run Sing-box Factory
        run: |
          SOURCE_DIR="src"
          OUTPUT_DIR="rule-set"
          mkdir -p "$OUTPUT_DIR"
          shopt -s nullglob
          
          # --- A. è¿œç¨‹è¿›è´§æ¸…å• (AdGuard è½¬æ¢) ---
          declare -a REMOTE_FILES=(
            "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt | AdGuardSDNSFilter"
          )
          
          # ----------------------------------------------------------------
          # 1. Processing Remote AdGuard Rules
          # ----------------------------------------------------------------
          echo ">>> 1. Processing Remote AdGuard Rules..."
          for rule in "${REMOTE_FILES[@]}"; do
            url="${rule%%|*}"
            name="${rule##*|}"
            url=$(echo "$url" | xargs)
            name=$(echo "$name" | xargs)

            echo "ğŸ“¥ Downloading: $name"
            curl --retry 5 --retry-delay 5 -L -s -o "temp_${name}.txt" "$url"

            if [ -f "temp_${name}.txt" ] && [ -s "temp_${name}.txt" ]; then
               sing-box rule-set convert --type adguard --output "${OUTPUT_DIR}/${name}.srs" "temp_${name}.txt" || echo "âš ï¸ Warning: sing-box conversion failed for ${name}"
               echo "âœ… Success: ${name}.srs"
               rm "temp_${name}.txt"
            else
               echo "âš ï¸ Warning: Download or file is empty: $url"
            fi
            echo "---"
          done

          # ----------------------------------------------------------------
          # 2. Processing Local JSON Rules
          # ----------------------------------------------------------------
          echo ">>> 2. Processing Local JSON Rules..."
          if [ -d "$SOURCE_DIR" ]; then
            for json_file in "$SOURCE_DIR"/*.json; do
              filename=$(basename "$json_file" .json)
              echo "ğŸ”¨ Compiling Sing-box JSON: $filename"
              sing-box rule-set compile --output "${OUTPUT_DIR}/${filename}.srs" "$json_file" || echo "âš ï¸ Warning: sing-box compilation failed for ${filename}. Check logs for error detail."
            done
          fi
          
          # ğŸ æœ€ç»ˆè°ƒè¯•ç‚¹ï¼šæ‰“å°æˆå“ç›®å½•å†…å®¹
          echo "--- Debug: Final Contents of rule-set/ directory ---"
          ls -la "$OUTPUT_DIR/"
          echo "----------------------------------------------------"

      # 3. æäº¤æˆå“åˆ°ä»“åº“ (æ ¸å¿ƒä¿®å¤ Git å†²çªé—®é¢˜)
      - name: Commit and Push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          find rule-set/ -name "*.srs" | xargs git add
          
          # ã€æ ¸å¿ƒä¿®å¤ã€‘è§£å†³è¿œç¨‹æ‹’ç»æ¨é€çš„é—®é¢˜ï¼šå…ˆæ‹‰å–æœ€æ–°ä»£ç å¹¶ä¸æœ¬åœ°æäº¤åˆå¹¶
          git pull --rebase origin main 
          
          git commit -m "Sing-box Factory output update [skip ci]" || exit 0
          git push
