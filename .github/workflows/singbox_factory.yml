name: Sing-box Rule Factory

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/singbox_factory.yml'

permissions:
  contents: write

jobs:
  produce-srs-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. å®‰è£… Sing-box (ä¿®å¤ä¸ºç¡¬ç¼–ç ç‰ˆæœ¬ï¼Œç¡®ä¿ç¨³å®š)
      - name: Install Sing-box
        run: |
          echo "--- Installing sing-box ---"
          # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬å·ï¼Œé¿å…ç‰ˆæœ¬å·è§£æå¤±è´¥
          S_VERSION_NUM="1.4.1" 
          wget --tries=5 "https://github.com/SagerNet/sing-box/releases/download/v${S_VERSION_NUM}/sing-box-${S_VERSION_NUM}-linux-amd64.tar.gz" -O sing-box.tar.gz
          tar -zxvf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sudo chmod +x /usr/local/bin/sing-box
          sing-box version

      # 2. è¿è¡Œå·¥å‚ç”Ÿäº§çº¿
      - name: Run Sing-box Factory
        run: |
          SOURCE_DIR="src"
          OUTPUT_DIR="rule-set"
          mkdir -p "$OUTPUT_DIR"
          shopt -s nullglob
          
          # --- A. è¿œç¨‹è¿›è´§æ¸…å• (AdGuard è½¬æ¢) ---
          declare -a REMOTE_FILES=(
            "https://raw.githubusercontent.com/217heidai/adblockfilters/main/rules/adblockdns.txt | adguard"
            "https://example.com/another-list.txt | custom_ad_list"
          )
          
          # ----------------------------------------------------------------
          # 1. Processing Remote AdGuard Rules
          # ----------------------------------------------------------------
          echo ">>> 1. Processing Remote AdGuard Rules..."
          for rule in "${REMOTE_FILES[@]}"; do
            url="${rule%%|*}"
            name="${rule##*|}"
            url=$(echo "$url" | xargs)
            name=$(echo "$name" | xargs)

            echo "ğŸ“¥ Downloading: $name"
            curl --retry 5 --retry-delay 5 -L -s -o "temp_${name}.txt" "$url"

            if [ -f "temp_${name}.txt" ] && [ -s "temp_${name}.txt" ]; then
               sing-box rule-set convert --type adguard --output "${OUTPUT_DIR}/${name}.srs" "temp_${name}.txt" || echo "âš ï¸ Warning: sing-box conversion failed for ${name}"
               echo "âœ… Success: ${name}.srs"
               rm "temp_${name}.txt"
            else
               echo "âš ï¸ Warning: Download or file is empty: $url"
            fi
            echo "---"
          done

          # ----------------------------------------------------------------
          # 2. Processing Local JSON Rules
          # ----------------------------------------------------------------
          echo ">>> 2. Processing Local JSON Rules..."
          if [ -d "$SOURCE_DIR" ]; then
            for json_file in "$SOURCE_DIR"/*.json; do
              filename=$(basename "$json_file" .json)
              echo "ğŸ”¨ Compiling Sing-box JSON: $filename"
              sing-box rule-set compile --output "${OUTPUT_DIR}/${filename}.srs" "$json_file" || echo "âš ï¸ Warning: sing-box compilation failed for ${filename}"
            done
          fi
          
          # ğŸ æœ€ç»ˆè°ƒè¯•ç‚¹ï¼šæ‰“å°æˆå“ç›®å½•å†…å®¹
          echo "--- Debug: Final Contents of rule-set/ directory ---"
          ls -la "$OUTPUT_DIR/"
          echo "----------------------------------------------------"

      # 3. æäº¤æˆå“åˆ°ä»“åº“ 
      - name: Commit and Push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # åªæ·»åŠ  .srs æ–‡ä»¶
          find rule-set/ -name "*.srs" | xargs git add
          
          git commit -m "Sing-box Factory output update [skip ci]" || exit 0
          git push
