name: Mihomo Rule Factory (Docker Final)

# ===============================
# 触发条件 (已精确分离，避免与 Sing-box 冲突)
# ===============================
on:
  schedule:
    - cron: '30 0 * * *' # 每天 UTC 00:30 运行
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      # Mihomo 只监听列表文件 (Domain/IP-CIDR) 的变化
      - 'src/domain/**'
      - 'src/ip/**'
      - '.github/workflows/mihomo_factory.yml'

permissions:
  contents: write

jobs:
  produce-mrs-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. 核心步骤：使用 Mihomo 官方 Docker 镜像执行转换
      - name: Run Mihomo Conversions using Docker (Final FIXES)
        run: |
          SOURCE_DIR="src"
          OUTPUT_DIR="rule-set"
          
          mkdir -p "$OUTPUT_DIR"
          shopt -s nullglob
          
          # 【修复 1: 镜像名修正】使用正确的 metacubex/mihomo
          # 【修复 2: 权限修正】添加 --user 选项，解决静默失败（写入权限）问题
          DOCKER_RUN_PREFIX="docker run --rm -v ${{ github.workspace }}:/workspace --user $(id -u):$(id -g) metacubex/mihomo"
          
          # --- A. Domain 列表 (src/domain/*.list & *.txt -> .mrs) ---
          echo ">>> 1. Processing Mihomo Domain Lists (src/domain)"
          if [ -d "$SOURCE_DIR/domain" ]; then
            for list_file in "$SOURCE_DIR"/domain/*.list "$SOURCE_DIR"/domain/*.txt; do
              filename=$(basename "$list_file")
              filename=${filename%.list}
              filename=${filename%.txt}
              
              echo "⚙️ Converting Domain LIST: $filename"
              
              # Docker 内部的绝对路径
              INPUT_PATH="/workspace/${list_file}"
              OUTPUT_PATH="/workspace/rule-set/${filename}.mrs"
              
              $DOCKER_RUN_PREFIX convert-ruleset domain text "$INPUT_PATH" "$OUTPUT_PATH" || echo "⚠️ Warning: mihomo conversion failed for ${filename}. Check logs for error detail."
            done
          fi

          # --- B. IP-CIDR 列表 (src/ip/*.list & *.txt -> .mrs) ---
          echo ">>> 2. Processing Mihomo IPCIDR Lists (src/ip)"
          if [ -d "$SOURCE_DIR/ip" ]; then
            for list_file in "$SOURCE_DIR"/ip/*.list "$SOURCE_DIR"/ip/*.txt; do
              filename=$(basename "$list_file")
              filename=${filename%.list}
              filename=${filename%.txt}
              
              echo "⚙️ Converting IPCIDR LIST: $filename"
              
              # Docker 内部的绝对路径
              INPUT_PATH="/workspace/${list_file}"
              OUTPUT_PATH="/workspace/rule-set/${filename}.mrs"

              $DOCKER_RUN_PREFIX convert-ruleset ipcidr text "$INPUT_PATH" "$OUTPUT_PATH" || echo "⚠️ Warning: mihomo conversion failed for ${filename}. Check logs for error detail."
              
            done
          fi
          
          echo "--- Final Rule-set Contents ---"
          ls -la "$OUTPUT_DIR/"
          echo "-------------------------------"

      # 2. 提交产物到仓库 (使用强推，克服 Git 冲突)
      - name: Commit and Push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          find rule-set/ -name "*.mrs" | xargs git add
          
          git commit -m "Mihomo Factory output update [skip ci]" || exit 0
          
          git push --force-with-lease
