name: Mihomo Rule Factory (YAML Support)

# ===============================
# 触发条件 (已精确分离，避免与 Sing-box 冲突)
# ===============================
on:
  schedule:
    - cron: '30 0 * * *' # 每天 UTC 00:30 运行
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      # Mihomo 监听列表文件和YAML文件的变化
      - 'src/domain/**'
      - 'src/ip/**'
      - '.github/workflows/mihomo_factory.yml'

permissions:
  contents: write

jobs:
  produce-mrs-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. 核心步骤：使用 Mihomo 官方 Docker 镜像执行转换 (增强：支持 .yaml)
      - name: Run Mihomo Conversions using Docker (YAML Support)
        run: |
          SOURCE_DIR="src"
          OUTPUT_DIR="rule-set"
          
          mkdir -p "$OUTPUT_DIR"
          shopt -s nullglob
          
          # Docker 命令前缀（包含正确的镜像名和权限修复）
          DOCKER_RUN_PREFIX="docker run --rm -v ${{ github.workspace }}:/workspace --user $(id -u):$(id -g) metacubex/mihomo"
          
          # --- 辅助函数：处理转换逻辑 ---
          # $1: 规则类型 (domain/ipcidr), $2: 输入文件路径, $3: 输出文件路径, $4: 输入格式 (text/yaml)
          convert_rule() {
              local RULE_TYPE="$1"
              local INPUT_PATH="$2"
              local OUTPUT_PATH="$3"
              local INPUT_FORMAT="$4"
              local FILENAME=$(basename "${OUTPUT_PATH%.mrs}")

              echo "⚙️ Converting ${RULE_TYPE} (${INPUT_FORMAT}): ${FILENAME} (Source: ${INPUT_PATH})"
              $DOCKER_RUN_PREFIX convert-ruleset "${RULE_TYPE}" "${INPUT_FORMAT}" "${INPUT_PATH}" "${OUTPUT_PATH}" || \
                echo "⚠️ Warning: mihomo ${RULE_TYPE} conversion failed for ${FILENAME}. Check logs for error detail."
          }

          # --- A. Domain 列表 (src/domain/*.list, *.txt, *.yaml -> .mrs) ---
          echo ">>> 1. Processing Mihomo Domain Lists (src/domain)"
          if [ -d "$SOURCE_DIR/domain" ]; then
            # 1. 转换 TEXT/LIST 文件
            for list_file in "$SOURCE_DIR"/domain/*.list "$SOURCE_DIR"/domain/*.txt; do
              filename=$(basename "$list_file")
              filename=${filename%.list}
              filename=${filename%.txt}
              
              INPUT_PATH="/workspace/${list_file}"
              OUTPUT_PATH="/workspace/rule-set/${filename}.mrs"
              convert_rule domain "$INPUT_PATH" "$OUTPUT_PATH" text
            done
            
            # 2. 转换 YAML 文件
            for yaml_file in "$SOURCE_DIR"/domain/*.yaml; do
              filename=$(basename "$yaml_file")
              filename=${filename%.yaml}
              
              INPUT_PATH="/workspace/${yaml_file}"
              OUTPUT_PATH="/workspace/rule-set/${filename}.mrs"
              convert_rule domain "$INPUT_PATH" "$OUTPUT_PATH" yaml
            done
          fi

          # --- B. IP-CIDR 列表 (src/ip/*.list, *.txt, *.yaml -> .mrs) ---
          echo ">>> 2. Processing Mihomo IPCIDR Lists (src/ip)"
          if [ -d "$SOURCE_DIR/ip" ]; then
            # 1. 转换 TEXT/LIST 文件
            for list_file in "$SOURCE_DIR"/ip/*.list "$SOURCE_DIR"/ip/*.txt; do
              filename=$(basename "$list_file")
              filename=${filename%.list}
              filename=${filename%.txt}
              
              INPUT_PATH="/workspace/${list_file}"
              OUTPUT_PATH="/workspace/rule-set/${filename}.mrs"
              convert_rule ipcidr "$INPUT_PATH" "$OUTPUT_PATH" text
            done
            
            # 2. 转换 YAML 文件
            for yaml_file in "$SOURCE_DIR"/ip/*.yaml; do
              filename=$(basename "$yaml_file")
              filename=${filename%.yaml}
              
              INPUT_PATH="/workspace/${yaml_file}"
              OUTPUT_PATH="/workspace/rule-set/${filename}.mrs"
              convert_rule ipcidr "$INPUT_PATH" "$OUTPUT_PATH" yaml
            done
          fi
          
          echo "--- Final Rule-set Contents ---"
          ls -la "$OUTPUT_DIR/"
          echo "-------------------------------"

      # 2. 提交产物到仓库 (使用强推，克服 Git 冲突)
      - name: Commit and Push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          find rule-set/ -name "*.mrs" | xargs git add
          
          git commit -m "Mihomo Factory output update [skip ci]" || exit 0
          
          git push --force-with-lease
