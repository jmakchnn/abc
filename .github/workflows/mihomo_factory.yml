name: Mihomo Rule Factory (Docker Stable)

# ===============================
# 触发条件 
# ===============================
on:
  schedule:
    - cron: '30 0 * * *' 
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.github/workflows/mihomo_factory.yml'

permissions:
  contents: write

jobs:
  produce-mrs-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. 核心步骤：使用 Mihomo 官方 Docker 镜像执行转换
      - name: Run Mihomo Conversions using Docker
        run: |
          SOURCE_DIR="src"
          OUTPUT_DIR="rule-set"
          
          mkdir -p "$OUTPUT_DIR"
          shopt -s nullglob
          
          # 定义 Docker 命令的固定前缀，挂载工作目录到容器内的 /workspace
          DOCKER_RUN_PREFIX="docker run --rm -v ${{ github.workspace }}:/workspace metacu/mihomo"
          
          # --- A. Domain 列表 (src/domain/*.list & *.txt -> .mrs) ---
          echo ">>> 1. Processing Mihomo Domain Lists (src/domain)"
          if [ -d "$SOURCE_DIR/domain" ]; then
            for list_file in "$SOURCE_DIR"/domain/*.list "$SOURCE_DIR"/domain/*.txt; do
              filename=$(basename "$list_file")
              filename=${filename%.list}
              filename=${filename%.txt}
              
              echo "⚙️ Converting Domain LIST: $filename"
              
              # 【修复】使用 Docker 内部的绝对路径 /workspace/...
              INPUT_PATH="/workspace/${list_file}"
              OUTPUT_PATH="/workspace/rule-set/${filename}.mrs"
              
              # 在 Docker 容器内执行转换
              $DOCKER_RUN_PREFIX convert-ruleset domain text "$INPUT_PATH" "$OUTPUT_PATH" || echo "⚠️ Warning: mihomo conversion failed for ${filename}. Check logs for error detail."
            done
          fi

          # --- B. IP-CIDR 列表 (src/ip/*.list & *.txt -> .mrs) ---
          echo ">>> 2. Processing Mihomo IPCIDR Lists (src/ip)"
          if [ -d "$SOURCE_DIR/ip" ]; then
            for list_file in "$SOURCE_DIR"/ip/*.list "$SOURCE_DIR"/ip/*.txt; do
              filename=$(basename "$list_file")
              filename=${filename%.list}
              filename=${filename%.txt}
              
              echo "⚙️ Converting IPCIDR LIST: $filename"
              
              # 【修复】使用 Docker 内部的绝对路径 /workspace/...
              INPUT_PATH="/workspace/${list_file}"
              OUTPUT_PATH="/workspace/rule-set/${filename}.mrs"

              # 在 Docker 容器内执行转换
              $DOCKER_RUN_PREFIX convert-ruleset ipcidr text "$INPUT_PATH" "$OUTPUT_PATH" || echo "⚠️ Warning: mihomo conversion failed for ${filename}. Check logs for error detail."
              
            done
          fi
          
          echo "--- Final Rule-set Contents ---"
          ls -la "$OUTPUT_DIR/"
          echo "-------------------------------"

      # 2. 提交产物到仓库 (使用强推，克服 Git 冲突)
      - name: Commit and Push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          find rule-set/ -name "*.mrs" | xargs git add
          
          git commit -m "Mihomo Factory output update [skip ci]" || exit 0
          
          git push --force-with-lease
