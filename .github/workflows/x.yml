name: Compile Rulesets

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  x:
    runs-on: ubuntu-latest
    
    # ç¡®ä¿æœ‰æƒé™æäº¤æ–‡ä»¶
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Compile Rules (Clean & Stable)
        run: |
          # ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡º
          set -e  
          # æ‰¾ä¸åˆ°æ–‡ä»¶æ—¶ï¼Œé€šé…ç¬¦æ‰©å±•ä¸ºç©º
          shopt -s nullglob
          
          # æ›´æ–°å¹¶å®‰è£… jq (ç”¨äº sing-box å…¼å®¹æ€§)
          sudo apt-get update && sudo apt-get install -y jq
          
          mkdir -p out /tmp/fixed
          
          # ========== ä¸‹è½½å·¥å…· ==========
          echo "ğŸ“¥ Downloading tools (mihomo and sing-box)..."
          
          curl -fL https://github.com/MetaCubeX/mihomo/releases/download/v1.19.16/mihomo-linux-amd64-v1.19.16.gz -o /tmp/mihomo.gz
          gunzip -c /tmp/mihomo.gz > mihomo
          chmod +x mihomo
          
          curl -fL https://github.com/SagerNet/sing-box/releases/download/v1.12.12/sing-box-1.12.12-linux-amd64.tar.gz -o /tmp/sb.tar.gz
          tar xz -f /tmp/sb.tar.gz --strip-components=1
          chmod +x sing-box
          
          # ========== 1. è½¬æ¢æ‰€æœ‰ .json â†’ .srs (Sing-box) ==========
          echo "---"
          echo "ğŸ”§ Compiling .json to .srs (Sing-box)..."
          for f in in/*.json; do
            base=$(basename "$f" .json)
            FIXED_FILE="/tmp/fixed/$base.json"
            TARGET_FILE="out/$base.srs"
            
            # å…¼å®¹æ€§ä¿®æ­£ï¼šç¡®ä¿ç‰ˆæœ¬ä¸º 2
            jq 'if .version != 2 then .version = 2 else . end' "$f" > "$FIXED_FILE"
            
            echo "âœ… Compiling $f to $TARGET_FILE"
            ./sing-box rule-set compile --output "$TARGET_FILE" "$FIXED_FILE"
          done
          
          # ========== 2. è½¬æ¢æ‰€æœ‰ .yaml â†’ .mrs (Mihomo) ==========
          echo "---"
          echo "ğŸ”„ Converting .yaml to .mrs (Mihomo)..."
          for f in in/*.yaml; do
            base=$(basename "$f" .yaml)
            TARGET_FILE="out/$base.mrs"
            
            # ä½¿ç”¨æ›´å®‰å…¨çš„ 'domain' ç±»å‹
            echo "âœ… Converting $f to $TARGET_FILE"
            ./mihomo convert-ruleset domain yaml "$f" "$TARGET_FILE"
          done
          
          # ========== 3. è½¬æ¢ .list æ–‡ä»¶ (Mihomo Text) - è‡ªåŠ¨ç±»å‹åˆ¤æ–­/é»˜è®¤ Domain ==========
          echo "---"
          echo "ğŸ”„ Converting .list to .mrs (Mihomo Text)..."
          for f in in/*.list; do
            base=$(basename "$f" .list)
            TARGET_FILE="out/$base.mrs"
            RULE_TYPE=""
            
            # æ ¹æ®æ–‡ä»¶åå…³é”®è¯åˆ¤æ–­ç±»å‹
            if [[ "$f" == *ip* ]] || [[ "$f" == *cidr* ]]; then
              RULE_TYPE="ipcidr"
            elif [[ "$f" == *domain* ]] || [[ "$f" == *host* ]]; then
              RULE_TYPE="domain"
            fi
            
            # å¦‚æœæ–‡ä»¶åä¸åŒ…å«å…³é”®è¯ï¼Œé»˜è®¤ä¸º domain (è§£å†³ 345.list é—®é¢˜)
            if [ -z "$RULE_TYPE" ]; then
                RULE_TYPE="domain"
                echo "âš ï¸ Warning: File $f has no type hint in filename. Defaulting to domain."
            fi
            
            echo "âœ… Converting $f (Type: $RULE_TYPE) to $TARGET_FILE"
            ./mihomo convert-ruleset "$RULE_TYPE" text "$f" "$TARGET_FILE"
          done
          
          echo "âœ… All conversion processes completed successfully."

      - name: Commit files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: out/**
          commit_message: "ğŸ¤– chore: Auto update compiled rulesets"
