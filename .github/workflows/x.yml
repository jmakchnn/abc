name: Compile Rulesets

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
  # åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘å·¥ä½œæµ
  push:
    branches: [main]

jobs:
  x:
    runs-on: ubuntu-latest
    
    # æ˜¾å¼å£°æ˜å†™å…¥æƒé™ï¼Œç¡®ä¿ git-auto-commit-action å¯ä»¥æäº¤æ–‡ä»¶
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Compile Rules (Final & Stable)
        run: |
          # ç¡®ä¿ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡ºï¼Œå¹¶ç»™å‡ºæŠ¥é”™ä¿¡æ¯
          set -e  
          
          # å¯ç”¨ nullglobï¼Œå®‰å…¨å¤„ç†ä¸å­˜åœ¨çš„ .yaml æˆ– .list æ–‡ä»¶
          shopt -s nullglob
          
          # æ›´æ–°å¹¶å®‰è£… jq (ç”¨äºä¿®æ­£ sing-box çš„ JSON æ–‡ä»¶)
          sudo apt-get update && sudo apt-get install -y jq
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p out /tmp/fixed
          
          # ========== ä¸‹è½½å·¥å…· (ç›´æ¥ä¸‹è½½åˆ°å·¥ä½œç›®å½•) ==========
          echo "ğŸ“¥ Downloading tools (mihomo and sing-box)..."
          
          # ä¸‹è½½ Mihomo
          curl -fL https://github.com/MetaCubeX/mihomo/releases/download/v1.19.16/mihomo-linux-amd64-v1.19.16.gz -o /tmp/mihomo.gz
          gunzip -c /tmp/mihomo.gz > mihomo
          chmod +x mihomo
          
          # ä¸‹è½½ Sing-box
          curl -fL https://github.com/SagerNet/sing-box/releases/download/v1.12.12/sing-box-1.12.12-linux-amd64.tar.gz -o /tmp/sb.tar.gz
          tar xz -f /tmp/sb.tar.gz --strip-components=1
          chmod +x sing-box
          
          # ========== 1. è½¬æ¢æ‰€æœ‰ .json â†’ .srs (Sing-box) ==========
          echo "---"
          echo "ğŸ”§ Compiling .json to .srs (Sing-box)..."
          for f in in/*.json; do
            # [ -f "$f" ] || continue å·²ç»è¢« shopt -s nullglob å–ä»£
            
            base=$(basename "$f" .json)
            FIXED_FILE="/tmp/fixed/$base.json"
            TARGET_FILE="out/$base.srs"
            
            # å…¼å®¹æ€§ä¿®æ­£ï¼šå¼ºåˆ¶è®¾ç½® "version": 2ï¼Œé˜²æ­¢ Sing-box ç¼–è¯‘å¤±è´¥
            jq 'if .version != 2 then .version = 2 else . end' "$f" > "$FIXED_FILE"
            
            echo "âœ… Compiling $f to $TARGET_FILE"
            ./sing-box rule-set compile --output "$TARGET_FILE" "$FIXED_FILE"
          done
          
          # ========== 2. è½¬æ¢æ‰€æœ‰ .yaml â†’ .mrs (Mihomo) ==========
          echo "---"
          echo "ğŸ”„ Converting .yaml to .mrs (Mihomo, Domain type)..."
          for f in in/*.yaml; do
            base=$(basename "$f" .yaml)
            TARGET_FILE="out/$base.mrs"
            
            # å…¼å®¹æ€§ä¿®æ­£ï¼šä½¿ç”¨æ›´å®‰å…¨çš„ 'domain' ç±»å‹ï¼Œå¹¶ä¿®æ­£æ–‡ä»¶å
            echo "âœ… Converting $f to $TARGET_FILE"
            if ! ./mihomo convert-ruleset domain yaml "$f" "$TARGET_FILE"; then
                echo "âŒ FATAL: Mihomo YAML conversion failed for $f. è¯·æ£€æŸ¥ YAML æ ¼å¼æˆ–è§„åˆ™ç±»å‹æ˜¯å¦ä¸ºçº¯åŸŸåè§„åˆ™ã€‚"
                exit 1
            fi
          done
          
          # ========== 3. è½¬æ¢ .list æ–‡ä»¶ (Mihomo Text) ==========
          echo "---"
          echo "ğŸ”„ Converting .list to .mrs (Mihomo Text)..."
          for f in in/*.list; do
            base=$(basename "$f" .list)
            TARGET_FILE="out/$base.mrs"
            
            if [[ "$f" == *ip* ]] || [[ "$f" == *cidr* ]]; then
              echo "âœ… Converting $f (ipcidr) to $TARGET_FILE"
              if ! ./mihomo convert-ruleset ipcidr text "$f" "$TARGET_FILE"; then
                  echo "âŒ FATAL: Mihomo IP/CIDR list conversion failed for $f."
                  exit 1
              fi
            elif [[ "$f" == *domain* ]] || [[ "$f" == *host* ]]; then
              echo "âœ… Converting $f (domain) to $TARGET_FILE"
              if ! ./mihomo convert-ruleset domain text "$f" "$TARGET_FILE"; then
                  echo "âŒ FATAL: Mihomo Domain list conversion failed for $f."
                  exit 1
              fi
            fi
          done
          
          echo "âœ… All conversion processes completed successfully."
          # è°ƒè¯•ä¿¡æ¯ï¼šç¡®è®¤æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          echo "--- FINAL DEBUG: Listing out/ directory contents ---"
          ls -l out/
          echo "----------------------------------------------------"

      - name: Commit files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: out/**
          commit_message: "ğŸ¤– chore: Auto update compiled rulesets"
