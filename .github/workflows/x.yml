name: Compile Rulesets

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  x:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compile Rules (Exact Linux-equivalent)
        run: |
          set -e  # 任何命令失败立即退出

          mkdir -p out

          # ========== 下载 mihomo ==========
          curl -L https://github.com/MetaCubeX/mihomo/releases/download/v1.19.16/mihomo-linux-amd64-v1.19.16.gz -o /tmp/mihomo.gz
          gunzip -c /tmp/mihomo.gz > mihomo
          chmod +x mihomo

          # ========== 下载 sing-box ==========
          curl -L https://github.com/SagerNet/sing-box/releases/download/v1.12.12/sing-box-1.12.12-linux-amd64.tar.gz -o /tmp/sb.tar.gz
          tar xz -f /tmp/sb.tar.gz --strip-components=1
          chmod +x sing-box

          # ========== 转换所有 .json → .srs ==========
          for f in in/*.json; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .json)
            ./sing-box rule-set compile --output "out/$base.srs" "$f"
          done

          # ========== 转换所有 .yaml → .mrs (domain+ipcidr) ==========
          for f in in/*.yaml; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .yaml)
            ./mihomo convert-ruleset domain/ipcidr yaml "$f" "out/$base.mrs"
          done

          # ========== 转换 .list 文件 ==========
          for f in in/*.list; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .list)
            if [[ "$f" == *ip* ]] || [[ "$f" == *cidr* ]]; then
              ./mihomo convert-ruleset ipcidr text "$f" "out/$base.mrs"
            elif [[ "$f" == *domain* ]] || [[ "$f" == *host* ]]; then
              ./mihomo convert-ruleset domain text "$f" "out/$base.mrs"
            fi
          done
